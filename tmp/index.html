{"output":{"innerCSS":{},"outerCSS":{},"innerJS":{},"require":{"mod/raygl.main":1},"modules":[],"initJS":{"APP = require('raygl.main');\nsetTimeout(function (){if(typeof APP.start==='function')APP.start()});":1},"postInitJS":{},"include":{"fragment.c":1},"resource":{},"dynamicModules":{},"root":{"children":[{"type":1,"name":"html","children":[{"type":1,"name":"head","children":[{"type":1,"name":"title","attribs":{},"children":[{"type":2,"text":"demo-raytracing-shader"}]},{"type":1,"name":"meta","attribs":{"charset":"utf-8"},"void":true},{"type":1,"name":"meta","attribs":{"name":"viewport","content":"width=device-width, initial-scale=1, maximum-scale=1"},"void":true}]},{"type":1,"name":"body","children":[{"type":2,"text":"\n    "},{"type":5,"text":" <script src=\"sylvester.js\"></script> ","pos":30},{"type":2,"text":"\n    "},{"type":5,"text":" <w:vertex-shader id=\"vertex-shader\">vertex.c</w:vertex-shader> ","pos":80},{"type":2,"text":"\n    "},{"type":1,"name":"script","attribs":{"id":"fragment-shader","type":"x-shader/x-fragment"},"children":[{"type":2,"text":"//<![CDATA[\nprecision lowp float;\n\n#define RADIUS 70.0\n#define RADIUS_2 (RADIUS * RADIUS)\n#define SPARSITY 200.0\n#define HALF_SPARSITY (SPARSITY * 0.5)\n#define EYE 1000.0\n#define DEPTH 10\n#define BOUNCES 1\n\nconst float PI = 3.14159265357;\nconst vec3 back = vec3(0.0, 0.0, 0.0);\nconst vec4 BLACK = vec4(0.0, 0.0, 0.0, 1.0);\nconst vec4 WHITE = vec4(1.0, 1.0, 1.0, 1.0);\n\nvarying lowp vec3 vPoint;\nuniform highp float X;\nuniform highp float Y;\nuniform highp float Z;\nuniform highp float time;\nuniform sampler2D colors;\n\nstruct Sphere {\n  bool found;\n  vec3 center;\n  vec3 shift;\n  vec3 impact;\n  float radius;\n  vec4 color;\n};\n\n// Given the center of the sphere, this function set its current radius and base color.\nSphere setRadiusAndColor(Sphere sphere) {\n  float colorX = mod(abs(sphere.center.x * 13.954112\n                         + sphere.center.z * 73.897458), 1711.0) / 1711.0;\n  vec4 g = texture2D(colors, vec2(colorX, 0.5));\n  float r = g.y + g.x * time / 900.0;\n  g = texture2D(colors, vec2(fract(r), 0.5));\n  float p = g.w;\n  sphere.radius = RADIUS * (1.0 - p * 0.3);\n  vec3 center = sphere.center / SPARSITY;\n  colorX = mod(abs(center.x * 13.96 + center.y * 17.84 + center.z * 11.984122), 713.0) / 713.0;\n  sphere.color = texture2D(colors, vec2(colorX, 0.5));\n  sphere.shift = (vec3(sphere.color) + vec3(-0.5)) * (HALF_SPARSITY - RADIUS - 10.0);\n  return sphere;\n}\n\nSphere hitTest(vec3 point, vec3 vector, Sphere sphere) {\n  // Compute ray and sphere intersection.\n  // https://en.wikipedia.org/wiki/Line%E2%80%93sphere_intersection\n  vec3 v = normalize(vector);\n  vec3 o = point;\n  vec3 c = sphere.center + sphere.shift;\n  float r = sphere.radius;\n  vec3 co = o - c;\n  float tmp = dot(v, co);\n  float delta = tmp * tmp - dot(co, co) + r * r;\n  if (delta < 0.0) {\n    sphere.found = false;\n    return sphere;\n  }\n  float d = - tmp - sqrt(delta);\n  sphere.impact = o + v * d;\n  sphere.found = true;\n  return sphere;\n}\n\nSphere applyLight(Sphere sphere, vec3 origin) {\n  vec4 c0 = sphere.color * 0.1 + BLACK * 0.9;\n  vec4 c1 = sphere.color * 0.8 + WHITE * 0.2;\n  float r = (dot((sphere.impact - sphere.center) / sphere.radius, vec3(0.0, 0.0, -1.0)) + 1.0) * 0.5;\n  sphere.color = c1 * r + c0 * (1.0 - r);\n  float d = distance(origin, sphere.impact) / (SPARSITY * float(DEPTH));\n  sphere.color *= 1.0 - d;\n  return sphere;\n}\n\nvec3 getMainDirection(vec3 point, vec3 vector) {\n  // Find in which direction the vector points.\n  // There are 6 possible directions : X1, X2, Y1, Y2, Z1 and Z2.\n  float x = abs(vector.x);\n  float y = abs(vector.y);\n  float z = abs(vector.z);\n\n  if (x > y) {\n    // x > y\n    if (x > z) {\n      // x is the greatest.\n      return normalize(vec3(vector.x, 0.0, 0.0));\n    } else {\n      // z is the greatest.\n      return normalize(vec3(0.0, 0.0, vector.z));\n    }\n  } else {\n    // y > x\n    if (y > z) {\n      // y is the greatest.\n      return normalize(vec3(0.0, vector.y, 0.0));\n    } else {\n      // z is the greatest.\n      return normalize(vec3(0.0, 0.0, vector.z));\n    }\n  }\n}\n\nSphere findSphere(vec3 point, vec3 vector) {\n  vec4 color;\n  Sphere sphere;\n  bool found = false;\n  for (int bounce = 0 ; bounce < BOUNCES ; bounce++) {\n    vec3 mainVect = getMainDirection(point, vector);\n    if (mainVect.x != 0.0) {\n      if (mainVect.x > 0.0) {\n        sphere.center.x = SPARSITY * floor(point.x / SPARSITY) + SPARSITY;\n      } else {\n        sphere.center.x = SPARSITY * ceil(point.x / SPARSITY) - SPARSITY;\n      }\n      for (int loop = 0 ; loop < DEPTH ; loop++) {\n        float coeff = (sphere.center.x - point.x) / vector.x;\n        float z = point.z + vector.z * coeff + HALF_SPARSITY;\n        float y = point.y + vector.y * coeff + HALF_SPARSITY;\n        sphere.center.z = SPARSITY * floor(z / SPARSITY);\n        sphere.center.y = SPARSITY * floor(y / SPARSITY);\n        sphere = setRadiusAndColor(sphere);\n        sphere = hitTest(point, vector, sphere);\n        if (sphere.found) {\n          sphere = applyLight(sphere, point);\n          break;\n        }\n        sphere.center += mainVect * SPARSITY;\n      }\n    }\n    else if (mainVect.y != 0.0) {\n      if (mainVect.y > 0.0) {\n        sphere.center.y = SPARSITY * floor(point.y / SPARSITY) + SPARSITY;\n      } else {\n        sphere.center.y = SPARSITY * ceil(point.y / SPARSITY) - SPARSITY;\n      }\n      for (int loop = 0 ; loop < DEPTH ; loop++) {\n        float coeff = (sphere.center.y - point.y) / vector.y;\n        float x = point.x + vector.x * coeff + HALF_SPARSITY;\n        float z = point.z + vector.z * coeff + HALF_SPARSITY;\n        sphere.center.x = SPARSITY * floor(x / SPARSITY);\n        sphere.center.z = SPARSITY * floor(z / SPARSITY);\n        sphere = setRadiusAndColor(sphere);\n        sphere = hitTest(point, vector, sphere);\n        if (sphere.found) {\n          sphere = applyLight(sphere, point);\n          break;\n        }\n        sphere.center += mainVect * SPARSITY;\n      }\n    }\n    else if (mainVect.z != 0.0) {\n      if (mainVect.z > 0.0) {\n        sphere.center.z = SPARSITY * floor(point.z / SPARSITY) + SPARSITY;\n      } else {\n        sphere.center.z = SPARSITY * ceil(point.z / SPARSITY) - SPARSITY;\n      }\n      for (int loop = 0 ; loop < DEPTH ; loop++) {\n        float coeff = (sphere.center.z - point.z) / vector.z;\n        float x = point.x + vector.x * coeff + HALF_SPARSITY;\n        float y = point.y + vector.y * coeff + HALF_SPARSITY;\n        sphere.center.x = SPARSITY * floor(x / SPARSITY);\n        sphere.center.y = SPARSITY * floor(y / SPARSITY);\n        sphere = setRadiusAndColor(sphere);\n        sphere = hitTest(point, vector, sphere);\n        if (sphere.found) {\n          sphere = applyLight(sphere, point);\n          break;\n        }\n        sphere.center += mainVect * SPARSITY;\n      }\n    }\n    // Looking for the next ray bounce.\n    if (bounce > 0) {\n      if (sphere.found) {\n        color = color * 0.8 + sphere.color * 0.2;\n      }\n    } else {\n      found = sphere.found;\n      color = sphere.color;\n    }\n    point = sphere.impact;\n    vector = reflect(vector, sphere.impact - sphere.center);\n  }\n  sphere.found = found;\n  sphere.color = color;\n  sphere.color.w = 1.0;\n  return sphere;\n}\n\n\nvoid main(void) {\n  vec3 point = vec3(X, Y, Z);\n  vec3 vector = vec3(vPoint.x, vPoint.y, EYE);\n  Sphere sphere = findSphere(point, vector);\n  if (sphere.found) {\n    gl_FragColor = sphere.color;\n  } else {\n    gl_FragColor = vec4(back, 1.0);\n  }\n}//]]>"}]},{"type":2,"text":"\n    "},{"type":1,"name":"canvas","attribs":{"id":"glcanvas","width":"256","height":"256"},"children":[],"pos":231},{"type":2,"text":"\n    "},{"type":1,"name":"div","attribs":{"id":"fps"},"children":[],"pos":292},{"type":2,"text":"\n    "},{"type":1,"name":"center","attribs":{},"children":[{"type":2,"text":"\n        "},{"type":1,"name":"button","attribs":{"id":"res4","onclick":"res(4)"},"children":[{"type":2,"text":"Low res."}],"pos":334},{"type":2,"text":"\n        "},{"type":1,"name":"button","attribs":{"id":"res2","onclick":"res(2)"},"children":[{"type":2,"text":"Medium res."}],"pos":395},{"type":2,"text":"\n        "},{"type":1,"name":"button","attribs":{"id":"res1","onclick":"res(1)"},"children":[{"type":2,"text":"High res."}],"pos":459},{"type":2,"text":"\n    "}],"pos":317},{"type":2,"text":"\n"}]}],"pos":0}]}}}